<!DOCTYPE html>
<style>
body { height: 256px; background: #000; padding: 0; margin: 0; }
#map { height: 100%; width: 100%; }
#map { height: 100%; top: 20px; left: 20px; width: 80%; }
</style>

<div id="map"></div>
<button id="start">Draw [n]</button>
<button id="reset">Reset [r]</button>
<button id="grid">Grid</button>

<script src="http://maps.google.com/maps/api/js?sensor=false&libraries=geometry"></script>
<!-- dimes.ucsd.edu:8200 -->
<script src="https://www.google.com/jsapi?key=ABQIAAAATXJifusyeTqIXK5-oRfMqRT7NFPYQoGJ7jU_HZH5c99Vip7REBTXco2ruU-sf4ym1vUKQ7DmOK-EeA"></script>
<script>
google.load('earth', '1');
</script>
<script src="graticule.3.js"></script>
<script src="earth_map_type.js"></script>
<script src="dshape.js"></script>

<script>
// new EMapControl(Map, EarthMapType)
var EMapControl = (function () {
  function EmapControl(map, overlay, opts) {
    var self = this;

    if (!opts) {
      opts = {};
    }

    if (!opts.position) {
      opts.position = google.maps.ControlPosition.RIGHT_TOP;
    }

    var controlDiv = document.createElement('DIV');
    controlDiv.id = 'EMAPCONTROL';
    this.set('container', controlDiv);
    controlDiv.style.zIndex = 1002;
    map.controls[opts.position].push(controlDiv);

    var controlUI = document.createElement('DIV');
    controlUI.selectable = 'false';
    controlDiv.appendChild(controlUI);

    var controlText = document.createElement('DIV');
    controlText.style.background = 
      "url('/images/cchdomap/emap_controls.png') repeat-y 0 100%";
    controlText.style.height = '30px';
    controlText.style.width = '40px';
    controlText.style.cursor = 'pointer';
    controlUI.appendChild(controlText);

    google.maps.event.addListener(map, 'emap_type_changed', function () {
    	if (map.get('emap_type') == 'map') {
        controlText.style.backgroundPosition = '0 100%';
      } else {
        self.get('container').style.zIndex = 
          overlay.get('container_earth').childNodes[0].style.zIndex + 1;
        controlText.style.backgroundPosition = '0 0';
      }
    });
    google.maps.event.addDomListener(controlUI, 'click', function () {
      if (map.getMapTypeId() != 'Earth') {
        overlay.show();
      } else {
        overlay.hide();
      }
    });
  }
  EmapControl.prototype = new google.maps.MVCObject();
  return EmapControl;
})();
</script>
<script>
var GM = google.maps;

window.onresize = (function () {
  document.getElementById('map').style.height = window.innerHeight - 30 + 'px';
})();

window.onload = function () {
  EARTH = true;
  alpha = 32.870100, beta = -117.25152, gamma = 0.00003;
  biograde = new GM.LatLng(alpha, beta);
  biograde1 = new GM.LatLng(alpha - gamma, beta - gamma);
  biograde2 = new GM.LatLng(alpha, beta - gamma);

  var maptypes = [
    GM.MapTypeId.TERRAIN,
    GM.MapTypeId.SATELLITE,
    GM.MapTypeId.HYBRID,
    GM.MapTypeId.ROADMAP];
  if (EARTH) {
    maptypes.push('Earth');
  }

  window.map = new GM.Map(document.getElementById('map'), {
    center: biograde,
    mapTypeId: GM.MapTypeId.ROADMAP,
    zoom: 10,
    mapTypeControlOptions: {
      style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
      mapTypeIds: maptypes
    }
  });

  function init() {
    // BUTTONS
    window.shapes = new GM.MVCArray();

    GM.event.addDomListener(document.getElementById('start'), 'click', function () {
      var shape = new DShape({map: map, strokeColor: '#aaffaa', fillColor: '#5555ff'});
      shapes.push(shape);

      //shape.set('line', true);

      var updated = GM.event.addListener(shape, 'draw_updated', function () {
        console.log('drawing updated');
      });

      var shapechanged = GM.event.addListener(shape, 'shape_changed', function () {
        console.log('shapechanged');
      });

      var editable = GM.event.addListener(shape, 'editable_changed', function () {
        console.log('Editable', shape.get('editable'));
      });

      GM.event.addListenerOnce(shape, 'draw_ended', function () {
        GM.event.removeListener(updated);
        GM.event.removeListener(editable);
        document.getElementById('start').disabled = '';
      });

      shape.start();
      document.getElementById('start').disabled = 'disabled';
    });
    //document.getElementById('start').click();

    document.getElementById('reset').addEventListener('click', function () {
      shapes.forEach(function (x) {
        GM.event.trigger(x, 'draw_canceled');
        x.unbind('map');
        x.setMap(null);
      });
      shapes.clear();
    });

    document.addEventListener('keydown', function (event) {
      if (event.keyCode == 78) {
        document.getElementById('start').click();
      } else if (event.keyCode == 82) {
        document.getElementById('reset').click();
      }
    });

    if (EARTH) {
      //map.setMapTypeId('Earth');
      GM.event.addDomListener(document.getElementById('grid'), 'click', function () {
        earth.set('graticules', !earth.get('graticules'));
      });
    } else {
      document.getElementById('grid').style.visibility = 'hidden';
    }
  }

  if (EARTH) {
    window.earth = new EarthMapType(map);
    GM.event.addListener(earth, 'initialized', init);
  } else {
    init();
  }
};

</script>
