{% extends "templates/base.jinja2" %}
{%- from "templates/_notes.jinja2" import show_notes, note_editor, show_notes_with_editor with context %}
{% block title %}Cruise {{cruise.expocode or ''}}{% endblock %}
{% block head -%}
  {{ whh.tags.stylesheet_link('/static/css/cruise.css') }}
  {{ whh.tags.stylesheet_link('/static/css/metaTable.css') }}
  {{ whh.tags.stylesheet_link('/static/css/overcast/jquery-ui-1.7.2.custom.css') }}
{%- endblock %}
{% macro cruise_attr(attr='', val='', callback=None, args) -%}
  {% if val %}
    <p><strong>{{attr}}:</strong> {% if callback %}{{ callback(val, args) }}{% else %}{{ val }}{% endif %}</p>
  {% endif %}
{%- endmacro %}
{%- macro see_or_discuss() %}
  {%- if request.user %}Discuss{%- else %}See{%- endif %}
{%- endmacro %}
{%- macro file_review_status(loop, hl, file) %}
  <tr class="mb-link{{ loop.index0 }} body {{ hl }} suggestion">
    <td class="change" colspan="2">
      {%- if file.pending_stamp %}
        <span class="pending">(Under review as of {{ file.pending_stamp.timestamp.strftime('%Y-%m-%d %H:%M') }})</span>
      {%- endif %}
    </td>
    <td colspan="2">
      {%- if h.has_mod(request) %}
        {{ whh.tags.form(
             '/obj/%s/a/%s' % (cruise.id, file.id),
             'PUT', multipart=True) }}
          <table>
            <tr>
              <td>
                <label for="file_{{ loop.index0 }}_accept_value">Merged the file? Select it here.</label>
                <input id="file_{{ loop.index0 }}_accept_value" type="file" name="accept_value">
              </td>
            </tr>
            <tr>
              <td>
                {%- if file.key == 'data_suggestion' %}
                  <label for="{{ loop.index0 }}_accept_key">File type</label>
                  {{ whh.tags.select('accept_key', None,
                                     FILE_GROUPS_SELECT,
                                     id="%d_accept_key" % loop.index0) }}
                {%- endif %}
                <input type="submit" name="action" value="Accept">
                {%- if not file.pending_stamp %}
                  <input type="submit" name="action" value="Acknowledge">
                {%- endif %}
                <input type="submit" name="action" value="Reject">
              </td>
            </tr>
          </table>
        {{ whh.tags.end_form() }}
      {%- endif %}
    </td>
  </tr>
{%- endmacro %}
{%- macro file_subsection(title, subsection_type) %}
  <div class="subsection">
    <h2>{{ title }}</h2>
    <div id="{{ subsection_type }}">
      <table class="has-meta-bodies">
        <tr class="header">
          <th class="file_type">File Type</th>
          <th>File</th>
          <th class="file_date">Date
            {%- if subsection_type == 'as_received' %}
              Received
            {%- elif subsection_type == 'merged' %}
              Merged
            {%- endif %}
          </th>
          <th class="suggested_by">Suggested by</th>
        </tr>
        {%- for file in updates[subsection_type] %}
          {%- set hl = loop.cycle('even', 'odd') %}
          <tr class="mb-link{{ loop.index0 }} meta {{ hl }}">
            <td class="file_type">{{ file.key }}</td>
            <td>
              {%- if file.is_acknowledged() or file.is_accepted() %}
                {{ h.link_file_holder(file) }}
              {%- else %}
                {# Unacknowledged files are not shown to the public #}
                {{ file.file.name }}
              {%- endif %}
            </td>
            <td class="file_date">{{ h.date(file.creation_stamp.timestamp) }}</td>
            <td class="suggested_by">{{ h.link_person(file.creation_stamp.person) }}</td>
          </tr>
          {%- if not file.is_judged() %}
            {{ file_review_status(loop, hl, file) }}
          {%- endif %}
          {%- if file or h.has_mod(request) %}
            <tr class="mb-link{{ loop.index0 }} body {{ hl }}">
              <td colspan="4">
                {{ show_notes_with_editor(request, loop.index0, file, subsection_type) }}
              </td>
            </tr>
          {%- endif %}
        {%- endfor %}
      </table>
    </div>
  </div>
{%- endmacro %}
{%- block content_attrs %} {% if cruise.accepted %}class="cruise-page"{% else %}class="cruise-page pending"{% endif %}{%- endblock %}
{%- block content %}
  {%- if not cruise.accepted %}
    <div id="pending-review" class="flash warning">
      {%- if h.has_mod(request) %}
        <p>This cruise was entered by the public and needs to be reviewed.</p>
        {{ whh.tags.form('/obj/%s' % cruise.id, 'PUT') }}
          <input type="submit" name="action" value="Accept">
          <input type="submit" name="action" value="Reject">
        {{ whh.tags.end_form() }}
      {%- else %}
        <p>This cruise was entered by the public and has not yet been reviewed.</p>
      {%- endif %}
    </div>
  {%- endif %}
  {%- call h.boxed('General Information and Files', id='info', class='upper', box_content_class='scrollable-y') %}
    <div class="subsection general-information">
      <h2>General Information</h2>
      {%- if 'map' in data_files %}
        {{ h.cruise_map_thumb(data_files['map'].get('thumb', None), data_files['map'].get('full', None)) }}
      {%- endif %}
      {{- cruise_attr('ExpoCode', cruise.expocode) }}
      {{- cruise_attr('Aliases', cruise.get('aliases', [])|join(', ')) }}
      {{- cruise_attr('Collections', h.link_collections(cruise.collections)) }}
      {%- if cruise.ship %}
        {{ cruise_attr('Ship', h.link_ship(cruise.ship)) }}
      {%- endif %}
      {%- if cruise.country %}
        {{ cruise_attr('Country', h.link_country(cruise.country)) }}
      {%- endif %}
      {{- cruise_attr('Chief Scientists',
                      h.link_person_institutions(cruise.chief_scientists)) }}
      {{- cruise_attr('Cruise Dates', cruise_dict['cruise_dates']) }}
      {{- cruise_attr('Expedition Link', cruise.get('link'), whh.tags.link_to, cruise.get('link')) }}
      {{- cruise_attr('ID', whh.tags.link_to(cruise.id, request.route_url('cruise_show', cruise_id=cruise.id))) }}

      {%- if updates['attrs'] %}
        <a class="updates-available" href="#updates">{{ see_or_discuss() }} suggested attribute changes</a>
      {%- endif %}

      {%- if h.has_mod(request) %}
        <div id="edit_attr" class="editor">
        {{ whh.tags.form('', 'PUT', hidden_fields={'action': 'edit_attr'}) }} 
          <table>
            <tr>
              <th>{{ whh.tags.select('key', None, CRUISE_ATTRS_SELECT) }}</th>
              <td><input type="text" name="value" placeholder="value"></td>
            </tr>
            <tr>
              <th><label for="edit_attr_notes">Notes</label></th>
              <td><textarea id="edit_attr_notes" name="notes"></textarea></td>
            </tr>
            <tr>
              <td class="submit" colspan="2">
                <input type="submit" name="edit_action" value="Delete">
                <input type="submit" name="edit_action" value="Set">
              </td>
            </tr>
          </table>
          </p>
        {{ whh.tags.end_form() }}
        </div>
      {%- endif %}
    </div>
    <div class="clear"></div>
    <div class="subsection data-files">
      <h2>Data Files</h2>

      {%- if cruise.preliminary %}
        <p id="preliminary">These data are preliminary (Please see 
          <a href="">data history</a>)</p> 
      {%- endif %}
      {%- if updates['as_received'] or updates['merged'] %}
        <a class="updates-available" href="#updates">
          {{ see_or_discuss() }} as received files and see merged files</a>
      {%- endif %}

      {%- if 'exchange' in data_files %}
        <h3>Exchange</h3>
        <table>
        {% for type, df in h.sort_data_files(data_files.get('exchange')) -%}
          {{ h.data_file_link(type, df) }}
        {%- endfor %}
        </table>
      {%- endif %}

      {%- if 'netcdf' in data_files %}
        <h3>NetCDF</h3>
        <table>
        {% for type, df in h.sort_data_files(data_files.get('netcdf')) -%}
          {{ h.data_file_link(type, df) }}
        {%- endfor %}
        </table>
      {%- endif %}

      {%- if 'woce' in data_files %}
        <h3>WOCE</h3>
        <table>
        {% for type, df in h.sort_data_files(data_files.get('woce')) -%}
          {{ h.data_file_link(type, df) }}
        {%- endfor %}
        </table>
      {%- endif %}

      {%- if 'doc' in data_files %}
        <h3>Documentation</h3>
        <table>
        {% for type, df in h.sort_data_files(data_files.get('doc')) -%}
          {{ h.data_file_link(type, df) }}
        {%- endfor %}
        </table>
      {%- endif %}
      {%- if not data_files %}
        <div id="data-pending">
          <h4>Data Pending</h4>
          <p>Contact the CCHDO for more information.</p>
          <p>If you are the PI, please contact the CCHDO for submission
             information.</p>
        </div>
      {%- endif %}
      {%- if h.has_mod(request) %}
        <div id="add_file" class="editor">
        {{ whh.tags.form('', 'PUT', multipart=True,
                         hidden_fields={'action': 'suggest_file'}) }} 
          <table>
            <tr>
              <th>{{ whh.tags.select('type', None, FILE_GROUPS_SELECT) }}</th>
              <td><input type="file" name="file"></td>
            </tr>
            <tr>
              <th><label for="suggest_file_notes">Notes</label></th>
              <td><textarea id="suggest_file_notes" name="notes"></textarea></td>
            </tr>
            <tr>
              <td class="submit" colspan="2">
                <input type="submit" name="add_file_action" value="Delete file">
                <input type="submit" name="add_file_action" value="Set file">
              </td>
            </tr>
          </table>
        {{ whh.tags.end_form() }}
        </div>
      {%- endif %}
    </div>
  {%- endcall %}
  {% call h.boxed('Data Histories and Notes', id='history', class='upper', box_content_class='scrollable-y') -%}
    <div class="subsection">
      <h2>History</h2>
      {%- if h.has_mod(request) %}
        {{ whh.tags.form('', 'POST') }}
          <input type="hidden" name="action" value="add_note">
      {%- endif %}
      <table class="has-meta-bodies">
        <tr class="header"><th>Date</th><th>Data Type</th><th>Action</th><th>Summary</th></tr>
        {%- if h.has_mod(request) %}
          {%- set i = "new" %}
          {%- set hl="new" %}
          <tr class="mb-link{{ i }} meta {{ hl }} editor continued-top">
            <td>Add note</td>
            <td><input type="text" name="note_data_type"></td>
            <td><input type="text" name="note_action"></td>
            <td><input type="text" name="note_summary"></td>
          </tr>
          <tr class="mb-link{{ i }} body {{ hl }} editor continued-bottom">
            <td colspan="4">
              <p>
                <label for="note_discussion_{{ i }}">Public</label>
                <input id="note_discussion_{{ i }}" type="checkbox"
                       name="note_discussion" value="public" checked="checked">
               </p>
               <textarea name="note_note"></textarea>
               <input type="submit" value="Add note">
            </td>
          </tr>
        {%- endif %}
        {%- for change in history|reverse %}
          {{ h.cruise_history_rows(change, loop.index0, loop.cycle('even', 'odd')) }}
        {%- endfor %}
      </table>
      {%- if h.has_mod(request) %}
        </form>
      {%- endif %}
    </div>
  {%- endcall %}
  <div class="clear"></div>
  {%- if updates %}
    {%- call h.boxed('Updates', id="updates") %}
      {%- if updates['attrs'] %}
        <div class="subsection">
          <h2>Attributes</h2>
          <div id="attrs">
            <table class="has-meta-bodies">
              <tr class="header">
                <th>Attribute</th>
                <th>Suggested by</th>
                <th class="date">Suggested at</th>
              </tr>
              {%- for attr in updates['attrs'] %}
                {%- set hl = loop.cycle('even', 'odd') %}
                <tr class="mb-link{{ loop.index0 }} meta {{ hl }}">
                  <td>{{ attr.key }}</td>
                  <td>{{ h.link_person(attr.creation_stamp.person) }}</td>
                  <td class="date">{{ attr.creation_stamp.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                </tr>
                <tr class="mb-link{{ loop.index0 }} body {{ hl }} suggestion">
                  <td class="change">
                    {%- if attr.deleted %}
                      delete <span class="key">{{ attr.key }}</span>
                    {%- else %}
                      <span class="value">{{ attr.value }}</span>
                    {%- endif %}
                    {%- if attr.pending_stamp %}
                      <span class="pending">(Under review as of {{ attr.pending_stamp.timestamp.strftime('%Y-%m-%d %H:%M') }})</span>
                    {%- endif %}
                  </td>
                  <td colspan="2">
                    {%- if h.has_mod(request) %}
                      {{ whh.tags.form('/obj/%s/a/%s' % (cruise.id, attr.id), 'PUT') }}
                        <table>
                          <tr>
                            <td>
                              <label for="attr_{{ loop.index0 }}_accept_value">Accept a different value</label>
                              <input id="attr_{{ loop.index0 }}_accept_value" type="text" name="accept_value">
                            </td>
                          </tr>
                          <tr>
                            <td>
                              <input type="submit" name="action" value="Accept">
                              {%- if not attr.pending_stamp %}
                                <input type="submit" name="action" value="Acknowledge">
                              {%- endif %}
                              <input type="submit" name="action" value="Reject">
                            </td>
                          </tr>
                        </table>
                      {{ whh.tags.end_form() }}
                    {%- endif %}
                  </td>
                </tr>
                {%- if attr or h.has_mod(request) %}
                  <tr class="mb-link{{ loop.index0 }} body {{ hl }}">
                    <td colspan="4">
                      {{ show_notes_with_editor(request, loop.index0, attr, 'attr') }}
                    </td>
                  </tr>
                {%- endif %}
              {%- endfor %}
            </table>
          </div>
        </div>
      {%- endif %}
      {# TODO need to show files not acknowledged #}
      {%- if updates['as_received'] %}
        {{ file_subsection('Files as received', 'as_received') }}
      {%- endif %}
      {%- if updates['merged'] %}
        {{ file_subsection('Merged Files', 'merged') }}
      {%- endif %}
    {%- endcall %}
  {%- endif %}
  {%- if h.has_mod(request) %}
    {%- call h.boxed('Suggestions') %}
      <div class="subsection">
        <h3>Unacknowleged</h3>
        <table>
        <tr>
          <th>Key</th>
          <th>Value</th>
          <th>Suggested</th>
          <th>Actions</th>
        </tr>
        {%- for attr in cruise.unacknowledged_tracked()[::-1] %}
          <tr>
            <th>{{ attr.key }}</th>
            {%- if attr.deleted %}
              <td>delete</td>
            {%- else %}
              <td>{{ attr.value }}</td>
            {%- endif %}
            <td>
              <p>{{ attr.creation_stamp.timestamp }}</p>
              <p>{{ attr.creation_stamp.person }}</p>
            </td>
            <td>
              {{ whh.tags.form('/obj/%s/a/%s' % (cruise.id, attr.id), 'PUT') }}
                <input type="submit" name="action" value="Accept">
                <input type="submit" name="action" value="Acknowledge">
                <input type="submit" name="action" value="Reject">
              {{ whh.tags.end_form() }}
            </td>
          </tr>
        {%- endfor %}
        </table>

        <h3>Pending</h3>
        <table>
        <tr>
          <th>Key</th>
          <th>Value</th>
          <th>Suggested</th>
          <th>Pending</th>
          <th>Actions</th>
        </tr>
        {%- for attr in cruise.pending_tracked()[::-1] %}
          <tr>
            <th>{{ attr.key }}</th>
            {%- if attr.deleted %}
              <td>delete</td>
            {%- else %}
              <td>{{ h.attr_value(attr) }}</td>
            {%- endif %}
            <td>
              <p>{{ h.date(attr.creation_stamp.timestamp) }}</p>
              <p>{{ h.link_person(attr.creation_stamp.person) }}</p>
            </td>
            <td>
              <p>{{ h.date(attr.pending_stamp.timestamp) }}</p>
              <p>{{ h.link_person(attr.pending_stamp.person) }}</p>
            </td>
            <td>
              {{ whh.tags.form('/obj/%s/a/%s' % (cruise.id, attr.id), 'PUT') }}
                <input type="submit" name="action" value="Accept">
                <input type="submit" name="action" value="Reject">
              {{ whh.tags.end_form() }}
            </td>
          </tr>
        {%- endfor %}
        </table>

        <h3>Accepted</h3>
        <table>
        <tr>
          <th>id</th>
          <th>Key</th>
          <th>Value</th>
          <th>Suggested</th>
          <th>Accepted</th>
        </tr>
        {%- for attr in cruise.accepted_tracked()[::-1] %}
          <tr class="{{loop.cycle('even', 'odd')}}">
            <th><a href="/obj/{{ attr.obj.id }}/a/{{ attr.id }}">{{ attr.id }}</a></th>
            <th>{{ attr.key }}</th>
            {%- if attr.deleted %}
              <td>Deleted</td>
            {%- else %}
              <td>{{ h.attr_value(attr) }}</td>
            {%- endif %}
            <td>
              <p>{{ h.date(attr.creation_stamp.timestamp) }}</p>
              <p>{{ h.link_person(attr.creation_stamp.person) }}</p>
            </td>
            <td>
              <p>{{ h.date(attr.judgment_stamp.timestamp) }}</p>
              <p>{{ h.link_person(attr.judgment_stamp.person) }}</p>
            </td>
          </tr>
        {%- endfor %}
        </table>
      </div>
    {%- endcall %}
  {%- endif %}
{%- endblock %}
{% block js %}
  {{ whh.tags.javascript_link('/static/js/jquery-1.4.4.min.js') }}
  {{ whh.tags.javascript_link('/static/js/jquery-ui-1.8.14.custom.min.js') }}
  {{ whh.tags.javascript_link('/static/js/metaTable.js') }}
  <script>
    $('.boxed').each(function () {
      $(this).resizable({
        alsoResize: $(this).find('.box_content')});
    });
  </script>
{%- endblock %}
