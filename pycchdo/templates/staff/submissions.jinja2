{% extends "staff.jinja2" %}
{% from "_notes.jinja2" import show_notes, note_editor with context %}
{%- macro row_if_exists(t, x) %}
  {%- if x %}
    <tr><th>{{ t }}</th><td>{{ x }}</td></tr>
  {%- endif %}
{%- endmacro %}
{% block title -%}Submissions | Staff{%- endblock %}
{% block head -%}
  {{ whh.tags.stylesheet_link('/static/css/staff/submissions.css') }}
  {{ whh.tags.stylesheet_link('/static/css/metaTable.css') }}
{% endblock %}
{% block content -%}
  {% call h.boxed('Submissions') -%}
    <div class="help">
      <p>The key here is to attach submissions to specific cruises.</p>
      <ol>
        <li>Try to figure out what kind of data and which cruise each submission belongs to</li>
        <li>Then enter the cruise ID or expocode and data type and <span class="action">Accept</span></li>
      </ol>
      <p>
        If the submission is junk, <span class="action">Reject</span> it.
      </p>
      <p>
        If you're actively working on figuring a submission out, claim it by
        clicking <span class="action">Acknowledge</span>. You can add notes to
        the submission for your and others' reference.
      </p>
    </div>

    {%- if submissions %}
      <table class="has-meta-bodies autopagerize_page_element">
        <tr class="header">
          <th class="identifier">Identifier</th>
          <th class="actions">Actions</th>
          <th class="person">Person</th>
          <th class="file">File</th>
          <th class="date_submitted">Date submitted</th>
          <th class="type">Type</th>
          <th class="attached">Attached</th>
        </tr>
      {%- for submission in submissions %}
        {%- set hl = loop.cycle('even', 'odd') %}
        {%- set attached = submission.attached or None %}
        <tr class="submission mb-link{{ loop.index0 }} meta {{ hl }} {% if attached %}attached{% endif %}">
          {%- set ident = submission.expocode or ' ' %}
          <td class="identifier">{{ whh.tags.link_to(ident, request.route_url('cruise_show', cruise_id=ident)) }}</td>
          <td class="actions">{{ submission.action or '' }}</td>
          <td class="person">{{ h.link_person(submission.creation_person) }}</td>
          <td class="file">{{ h.link_file_holder(submission) }}</td>
          <td class="date_submitted">{{ h.pdate(submission.creation_timestamp) }}</td>
          <td class="type">{{ submission.type }}</td>
          <td class="attached">
            {# TODO attached can be either None, True, or _Attr. True is when the submission was imported. #}
            {%- if attached %}
              {%- if attached == True %}
                yes
              {%- else %}
                {{ h.link_cruise(attached.obj) }}
              {%- endif %}
            {%- else %}
              NO
            {%- endif %}
          </td>
        </tr>
        <tr class="submission mb-link{{ loop.index0 }} body {{ hl }} {% if attached %}attached{% endif %}">
          <td colspan="4">
            <table class="info">
              {{ row_if_exists('ID', h.link_obj(submission)) }}
              {{ row_if_exists('Acknowledged by', h.link_person(submission.pending_person)) }}
              {{ row_if_exists('Acknowledged on', h.pdate(submission.pending_timestamp)) }}
              {{ row_if_exists('Cruise dates', h.pdate(submission.cruise_date)) }}
              {{ row_if_exists('Ship', submission.ship_name or '') }}
              {{ row_if_exists('WOCE Line', submission.line or '') }}
            </table>
          </td>
          <td colspan="3">
          {%- if not attached %}
            {{ whh.tags.form('', 'PUT', hidden_fields={'submission_id': submission.id}) }}
            <table class="editor">
              <tr>
                <th><label for="submission{{ loop.index0 }}_cruise_id">Cruise ID/ExpoCode</label></th>
                {%- set cruises = submission.cruises_from_identifier() %}
                <td><input id="submission{{ loop.index0 }}_cruise_id" type="text" name="cruise_id"
                           value="{%- if cruises %}{{ cruises[0].get('expocode') or cruises[0].id }}{%- endif %}"></td>
              </tr>
              {%- set data_type_id = 'submission%s_data_type' % loop.index0 %}
              <tr>
                <th><label for="{{ data_type_id }}">Data type</label></th>
                <td>{{ whh.tags.select('data_type', None, FILE_GROUPS_SELECT, id=data_type_id) }}</td>
              </tr>
              <tr>
                <td colspan="2">
                  <input type="submit" name="action" value="Accept">
                  {%- if not submission.is_acknowledged() %}
                    <input type="submit" name="action" value="Acknowledge">
                  {%- endif %}
                  <input type="submit" name="action" value="Reject">
                </td>
              </tr>
            </table>
            {{ whh.tags.end_form() }}
          {%- endif %}
          </td>
        </tr>
        <tr class="submission mb-link{{ loop.index0 }} body {{ hl }} {% if attached %}attached{% endif %}">
          <td colspan="7">
            {{ whh.tags.form('', 'POST', hidden_fields={'obj_id': submission.id}) }}
            <table class="notes">
              {{ show_notes(submission.notes) }}
              {{ note_editor(loop.index0, 'file') }}
            </table>
            {{ whh.tags.end_form() }}
          </td>
        </tr>
      {%- endfor %}
      </table>
      {{ h.pager_for(submissions) }}
    {%- else %}
      <p>No submissions.</p>
    {%- endif %}
  {%- endcall %}
{%- endblock %}
{%- block js %}
  {{ whh.tags.javascript_link('/static/js/jquery-1.4.4.min.js') }}
  {{ whh.tags.javascript_link('/static/js/metaTable.js') }}
{%- endblock %}
